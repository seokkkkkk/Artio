<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>프로필</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                background-color: #f4f8fd;
                margin: 0;
                padding: 20px;
            }
            .container {
                width: 300px;
                padding: 20px;
                border: 1px solid #ddd;
                border-radius: 10px;
                background-color: #ffffff;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            h2 {
                text-align: center;
                color: #1d4ed8;
                margin-bottom: 20px;
            }
            .profile-info {
                margin-bottom: 20px;
            }
            .profile-info p {
                margin: 5px 0;
            }
            .form {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
            }
            textarea,
            input[type="file"] {
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                resize: none;
            }
            button {
                padding: 10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                color: #fff;
                background-color: #1d4ed8;
            }
            button:hover {
                background-color: #155ab6;
            }
            .post-list {
                margin-top: 20px;
            }
            .post-item {
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background-color: #f9fafb;
            }
            .post-item img {
                max-width: 100%;
                border-radius: 5px;
                margin-top: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>프로필 및 게시물 관리</h2>
            <div class="profile-info">
                <p>
                    <strong>사용자명:</strong>
                    <span id="username">Loading...</span>
                </p>
                <p>
                    <strong>가입 날짜:</strong>
                    <span id="createdAt">Loading...</span>
                </p>
            </div>

            <form
                class="form"
                id="postForm"
                action="/posts/upload"
                method="POST"
                enctype="multipart/form-data"
            >
                <textarea
                    name="content"
                    id="postContent"
                    rows="4"
                    placeholder="Write something..."
                    required
                ></textarea>
                <input type="file" name="image" accept="image/*" />
                <button type="submit">Post</button>
            </form>

            <div class="post-list" id="postList">
                <h3>내 게시물</h3>
            </div>
        </div>

        <script>
            async function loadProfileAndPosts() {
                try {
                    // 사용자 정보 가져오기
                    const profileResponse = await fetch("/api/user/profile");
                    const profileData = await profileResponse.json();

                    if (profileData.error) {
                        alert(profileData.error);
                        window.location.href = "/login.html";
                        return;
                    }

                    // 프로필 정보 업데이트
                    document.getElementById("username").textContent =
                        profileData.username;
                    document.getElementById("createdAt").textContent = new Date(
                        profileData.createdAt
                    ).toLocaleDateString();

                    // 게시물 가져오기
                    const postResponse = await fetch("/posts/my");
                    const postData = await postResponse.json();

                    const postList = document.getElementById("postList");
                    postList.innerHTML = "";

                    postData.forEach((post) => {
                        const postItem = document.createElement("div");
                        postItem.className = "post-item";
                        postItem.innerHTML = `
                            <p>${post.content}</p>
                            ${
                                post.imageUrl
                                    ? `<img src="${post.imageUrl}" alt="Post Image" />`
                                    : ""
                            }
                        `;
                        postList.appendChild(postItem);
                    });
                } catch (error) {
                    console.error("Failed to load profile and posts:", error);
                    alert("정보를 불러오지 못했습니다.");
                }
            }

            // 페이지 로드 시 프로필 및 게시물 정보 가져오기
            loadProfileAndPosts();

            // 게시물 작성 후 새로고침 방지 및 게시물 목록 갱신
            document.getElementById("postForm").onsubmit = async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const response = await fetch("/posts/upload", {
                    method: "POST",
                    body: formData,
                });

                if (response.ok) {
                    alert("게시물이 성공적으로 업로드되었습니다.");
                    this.reset();
                    loadProfileAndPosts(); // 게시물 목록 갱신
                } else {
                    alert("게시물 업로드 중 오류가 발생했습니다.");
                }
            };
        </script>
    </body>
</html>
